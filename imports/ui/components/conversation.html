<template name="conversation">
    <div class="conversation-container {{#if isShowInfo}}show-info{{/if}}">

        <div class="conversation-header">
            {{#if headerInfo}}
            <div class="d-flex align-items-center px-2">
                {{#if isGroup headerInfo.type}}
                <div class="group-avatar rounded-circle me-3">
                    <i class="fa-solid fa-users"></i>
                </div>
                <div class="w-100">
                    <h6 class="mb-1">{{headerInfo.groupName}}</h6>
                    <div class="current-message">
                        <small class="text-muted">{{headerInfo.members.length}} member{{#if
                            headerInfo.members.length}}s{{/if}}</small>
                    </div>
                </div>
                {{else}}
                <img src="{{headerInfo.avatar}}" class="rounded-circle me-3" width="45" height="45" alt="Avatar" />
                <div class="w-100">
                    <h6 class="mb-1">{{headerInfo.name}}</h6>
                    {{#if headerInfo.isSystem}}
                    <div class="current-message">
                        <small class="text-muted">System Message</small>
                    </div>
                    {{else}}
                    <div class="current-message">
                        <small class="text-muted">{{isUserOnline}}</small>
                    </div>
                    {{/if}}
                </div>
                {{/if}}

                {{#if isGroup headerInfo.type}}
                <svg id="toggle-info" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                    class="bi bi-layout-sidebar-inset-reverse" viewBox="0 0 16 16">
                    <path
                        d="M2 2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zm12-1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2z" />
                    <path d="M13 4a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1z" />
                </svg>
                {{/if}}
            </div>
            {{/if}}
        </div>

        <div class="conversation-body">
            {{#each messages}}
            {{#if isSystemMessage this}}
            <div class="system-message">
                {{content}}
            </div>
            {{else if isUserMessage this}}
            <div class="user-message">
                {{content}}
            </div>
            {{else}}
            <div class="your-message">
                {{content}}
            </div>
            {{/if}}
            {{/each}}
        </div>

        <div class="conversation-footer">
            <textarea id="message-input"></textarea>
            <div>
                <button class="btn btn-primary" id="send-message">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    {{#if isShowInfo}}
    <div class="info">
        <div class="group-avatar rounded-circle">
            <i class="fa-solid fa-users"></i>
        </div>

        {{#if isEditingGroupName}}
        <div class="d-flex align-items-center gap-2 mt-3">
            <input id="group-name-input" type="text" class="form-control w-100" value="{{headerInfo.groupName}}" />
            <div class="d-flex gap-1">
                <button class="btn btn-primary" id="save-group-name">Save</button>
                <button class="btn btn-secondary" id="cancel-edit-group-name">Cancel</button>
            </div>
        </div>
        {{else}}
        <h5 class="mt-3">
            {{headerInfo.groupName}} {{#if isLeader}}<i id="edit-group-name"
                class="fa-solid fa-pen-to-square"></i>{{/if}}
        </h5>
        {{/if}}

        <div class="w-100 mt-2">
            <div class="w-100 d-flex justify-content-between align-items-center">
                <h6>Members ({{headerInfo.members.length}})</h6> 
                <i class="fa-solid fa-plus" data-bs-toggle="modal" data-bs-target="#inviteModal"></i>
            </div>
            <div class="d-flex flex-column gap-3">
                {{#each headerInfo.members}}
                <div class="d-flex align-items-center">
                    <div class="position-relative d-inline-block">
                        <img src="{{this.services.google.picture}}" class="rounded-circle me-3" width="45" height="45"
                            alt="Avatar" />

                        {{#if isMemberOnline this._id}}
                        <span
                            class="badge-online position-absolute bottom-0 translate-middle p-1 bg-success border border-light rounded-circle">
                            <span class="visually-hidden">Online</span>
                        </span>
                        {{/if}}
                    </div>

                    <div>
                        <h6 class="mb-1">{{#if isYou this._id}}You{{else}} {{this.profile.name}}{{/if}} {{#if isLeader
                            this._id}}(Leader){{/if}}</h6>
                        <small class="text-muted">{{this.services.google.email}}</small>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>

        <div class="d-flex flex-column gap-2 justify-content-between align-items-center mt-auto w-100">
            {{#if isLeader}}
            <button class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                data-bs-target="#changeGroupLeaderModal">Change
                Group Leader</button>

            <button class="btn btn-outline-danger w-100" data-bs-toggle="modal"
                data-bs-target="#disbandGroupModal">Disband
                Group</button>
            {{else}}
            <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#leaveGroupModal">Leave
                Group</button>
            {{/if}}


        </div>
    </div>

    <div class="modal fade" id="inviteModal" tabindex="-1" role="dialog" aria-labelledby="inviteModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inviteModalLabel">Add Members</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="members" class="form-label">Members</label>
                    <!-- {{#if members.length}}
                    <div class="members-list mb-3">
                        {{#each members}}
                        <div class="member-item d-flex gap-2 align-items-center border border-secondary mb-2">
                            <img src="{{getUserAvatar this}}" class="rounded-circle me-1" width="20" height="20"
                                alt="Avatar" />
                            <span>{{getUserDisplayName this}}</span>
                            <i class="fa-solid fa-xmark icon-remove-member" data-user-id="{{_id}}"></i>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}} -->

                    <div class="d-flex align-items-center gap-2 mb-3">
                        <input type="text" class="form-control" id="usernameOrEmail"
                            placeholder="Enter username or email" />
                        <button type="button" class="btn btn-primary" id="searchUser">Search</button>
                    </div>

                    {{#if searchResults.length}}
                    <div class="list-group">
                        {{#each searchResults}}
                        <div class="list-group-item d-flex align-items-center justify-content-between py-3">
                            <div class="d-flex align-items-center">
                                <img src="{{getUserAvatar this}}" class="rounded-circle me-3" width="45" height="45"
                                    alt="Avatar" />
                                <div>
                                    <h6 class="mb-1">{{getUserDisplayName this}}</h6>
                                    <small class="text-muted">{{getUserEmail this}}</small>
                                </div>
                            </div>
                            <button id="invite-to-group" class="btn btn-outline-primary btn-sm" data-user-id="{{_id}}">
                                Invite to Group
                            </button>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmInvite" data-bs-dismiss="modal">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changeGroupLeaderModal" tabindex="-1" role="dialog"
        aria-labelledby="changeGroupLeaderModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeGroupLeaderModalLabel">Confirm Change Group Leader</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="newGroupLeader" class="form-label">Select New Group Leader</label>
                    <select id="newGroupLeader" class="form-select">
                        {{#each members}}
                        <option value="{{this._id}}">{{this.profile.name}}</option>
                        {{/each}}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmChangeGroupLeader"
                        data-bs-dismiss="modal">Change</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="leaveGroupModal" tabindex="-1" role="dialog" aria-labelledby="leaveGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leaveGroupModalLabel">Confirm Leave Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to leave this group?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLeaveGroup"
                        data-bs-dismiss="modal">Leave</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="disbandGroupModal" tabindex="-1" role="dialog" aria-labelledby="disbandGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="disbandGroupModalLabel">Confirm Disband Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to disband this group?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDisbandGroup"
                        data-bs-dismiss="modal">Disband</button>
                </div>
            </div>
        </div>
    </div>
    {{/if}}


</template>